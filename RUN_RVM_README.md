# RVM一键启动程序使用指南

## 快速开始

### 方式1：一键运行（推荐）

```bash
python run_with_rvm.py
```

这个程序会自动：
- ✓ 检查并加载配置
- ✓ 检测CUDA/GPU状态
- ✓ 初始化所有模块
- ✓ 尝试加载RVM模型（如果有的话）
- ✓ 提供完整的调试信息

### 方式2：强制使用RVM

如果您已经下载了RVM模型：

```bash
python run_with_rvm.py --rvm
```

### 方式3：指定配置文件

```bash
python run_with_rvm.py --config my_config.yaml
```

## 键盘控制

程序启动后，使用以下键盘快捷键：

### 显示模式切换

| 按键 | 功能 | 说明 |
|------|------|------|
| **1** | 完整摄像头画面 | 显示原始摄像头画面（带ROI标记） |
| **2** | ROI区域 | 显示裁剪后的有效区域 |
| **3** | 骨骼检测调试 | 显示骨骼检测的详细调试信息 |
| **4** | 抠像模块调试 | 显示抠像模块的详细调试信息 |
| **5** | 所有调试信息 | 一次性开启/关闭所有调试信息 |

### 其他控制

| 按键 | 功能 |
|------|------|
| **C / c** | 切换摄像头 ⭐新增 |
| **F / f** | 切换FPS显示 |
| **H / h** | 切换提示信息显示 ⭐新增 |
| **S / s** | 保存当前帧到文件 |
| **R / r** | 重置统计信息 |
| **Q / q** | 退出程序 |

### 画面提示信息 ⭐新增

程序会在画面左上角显示状态信息（可按H键切换显示/隐藏）：

- **当前模式**：显示已激活的调试模式（[1]完整画面、[2]ROI、[3]骨骼、[4]抠像等）
- **摄像头编号**：显示当前使用的摄像头ID
- **抠像模式**：显示使用的抠像算法（RVM或简化版）
- **FPS**：实时帧率（如果开启FPS显示）

## 使用示例

### 示例1：仅查看完整画面

1. 运行程序：`python run_with_rvm.py`
2. 按 **1** 键
3. 查看完整摄像头画面和ROI标记

### 示例2：排查骨骼检测问题

1. 运行程序：`python run_with_rvm.py`
2. 按 **3** 键（开启骨骼检测调试）
3. 终端会显示：
   - 检测到的人数
   - 每个关键点的可见性
   - 每个人的完整性分数
   - 最佳人物的选择原因

### 示例3：排查抠像问题

1. 运行程序：`python run_with_rvm.py`
2. 按 **4** 键（开启抠像模块调试）
3. 终端会显示：
   - 使用的模型类型（RVM或简化版）
   - GPU/CPU设备信息
   - 降采样比例
   - 处理时间
   - Alpha通道形状

### 示例4：查看所有信息

1. 运行程序：`python run_with_rvm.py`
2. 按 **5** 键
3. 所有调试信息都会显示

### 示例5：切换摄像头 ⭐新增

1. 运行程序：`python run_with_rvm.py`
2. 按 **C** 键尝试切换到下一个摄像头
3. 程序会自动尝试0-4号摄像头，找到第一个可用的
4. 终端会显示切换结果

### 示例6：隐藏/显示提示信息 ⭐新增

1. 运行程序：`python run_with_rvm.py`
2. 按 **H** 键隐藏画面上的提示信息
3. 再次按 **H** 键重新显示
4. 提示信息包括：模式、摄像头、抠像类型、FPS

## 终端输出说明

### 启动时的输出

程序启动时会显示7个初始化步骤：

```
[1/7] 加载配置文件...              ✓ 成功/失败状态
[2/7] 检查GPU/CUDA状态...          GPU信息
[3/7] 初始化摄像头...             摄像头分辨率
[4/7] 初始化骨骼检测器...          ✓ 成功
[5/7] 初始化人物选择器...          ✓ 成功
[6/7] 初始化人体抠像模块...        RVM加载状态
[7/7] 初始化可视化模块...          ✓ 成功
```

### 调试信息输出

#### 骨骼检测调试（按键3）

```
--- 骨骼检测调试信息 ---
检测到人数: 2
  人物 1:
    可见关键点: 28/33
    完整性: 84.85%
    高度: 720 pixels
    边界框: (100, 50, 580, 770)

最佳人物:
  总评分: 0.825
  完整性: 0.848
  高度: 1.000
  居中度: 0.654
--- 调试信息结束 ---
```

#### 抠像模块调试（按键4）

```
--- 抠像模块调试信息 ---
模型类型: rvm_real
设备: cuda
降采样比例: 0.25
过滤不完全: True
Alpha通道形状: (720, 1280)
处理时间: 12.34 ms
--- 调试信息结束 ---
```

### 程序结束时的统计信息

```
程序统计信息
==============================================================================
平均FPS: 18.5
最高FPS: 25.3
最低FPS: 12.1
总检测次数: 542
==============================================================================
```

## 故障排查

### 问题1：摄像头无法打开

**现象**：
```
[3/7] 初始化摄像头...
✗ 摄像头初始化失败
```

**解决方法**：
1. 检查config.yaml中的device_id是否正确
2. 确认摄像头没有被其他程序占用
3. 尝试不同的device_id值

### 问题2：RVM模型加载失败

**现象**：
```
[6/7] 初始化人体抠像模块...
RVM model file not found. Please download it using:
  python download_rvm_model.py
✓ 简化版抠像初始化成功
```

**说明**：这是正常的，程序会自动使用简化版本

**如果想使用RVM**：
```bash
python download_rvm_model.py
```

### 问题3：CUDA不可用

**现象**：
```
[2/7] 检查GPU/CUDA状态...
⚠ CUDA不可用，将使用CPU（速度较慢）
```

**解决方法**：
1. 检查显卡驱动是否正确安装
2. 安装CUDA版本的PyTorch
3. 验证CUDA工具包

### 问题4：按数字键没有反应

**可能原因**：
1. 焦点不在视频窗口上 - 点击视频窗口后再按
2. 没有检测到人物 - 调整光照或位置
3. 模式已关闭 - 再次按相同数字键切换

### 问题5：调试信息太频繁

**解决方法**：
- 按对应数字键关闭该调试模式
- 或按 5 键关闭所有调试信息

## 性能优化建议

### 如果FPS太低

1. **降低分辨率**
   ```yaml
   # config.yaml
   camera:
     resolution: [640, 480]  # 从1280x720降低
   ```

2. **缩小ROI区域**
   ```yaml
   roi:
     x_min: 0.45  # 减小区域
     x_max: 0.55
   ```

3. **增加降采样**
   ```yaml
   matting:
     downsample_ratio: 0.5  # 从0.25增加到0.5
   ```

### 如果抠像质量不够好

1. **检查是否使用RVM**
   - 启动时查看是否有"✓ RVM模型加载成功"
   - 按 4 键查看模型类型

2. **优化光照**
   - 使用均匀的正向光照
   - 避免逆光

3. **使用纯色背景**
   - 绿色背景效果最好
   - 简化版算法对纯色背景效果更好

## 功能对比

| 功能 | run_with_rvm.py（RVM版） | src/main.py（原版） |
|------|-------------------------|-------------------|
| 一键启动 | ✓ | ✓ |
| 详细初始化信息 | ✓ | ⚠ 基本 |
| 键盘调试切换 | ✓ | ⚠ 固定显示 |
| 终端调试输出 | ✓ | ✗ |
| 实时统计信息 | ✓ | ⚠ 仅FPS |
| RVM优先加载 | ✓ | ⚠ 自动检测 |

## 常见使用流程

### 首次运行

```bash
# 1. 运行程序查看初始化
python run_with_rvm.py

# 2. 如果RVM未加载，按Q退出

# 3. 下载RVM模型（可选）
python download_rvm_model.py

# 4. 再次运行
python run_with_rvm.py
```

### 日常使用

```bash
# 直接运行
python run_with_rvm.py

# 调整调试模式
# 按 2 查看ROI
# 按 3 查看骨骼检测
# 按 4 查看抠像
# 按 Q 退出
```

### 调试模式

```bash
# 1. 开启所有调试
python run_with_rvm.py
# 按 5

# 2. 查看终端输出分析问题

# 3. 保存问题帧
# 按 S

# 4. 按需切换各个模式精确定位
```

## 提示和技巧

1. **多个显示窗口**：按多个数字键可以同时显示多个窗口
2. **保存调试帧**：遇到问题时按S保存，方便后续分析
3. **观察终端**：重要的调试信息都在终端输出
4. **先按2后按3**：先看ROI是否正确裁剪，再看骨骼检测
5. **FPS监控**：长期观察FPS稳定性，及时优化性能

## 与官方RVM集成

如果您的RVM模型来自官方仓库：

1. 克隆官方仓库：
   ```bash
   git clone https://github.com/PeterL1n/RobustVideoMatting.git
   ```

2. 下载模型到models目录

3. 运行程序会自动检测

## 帮助和支持

- 查看 `RVM_INTEGRATION.md` 了解RVM详细集成说明
- 查看 `INSTALL.md` 了解详细安装步骤
- 查看 `USAGE.md` 了解基础使用
- 查看终端输出的错误信息排查问题

---

**祝使用愉快！**

