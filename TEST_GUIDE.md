# 功能测试指南

## 测试前准备

1. **确认依赖已安装**：
   ```bash
   pip install -r requirements.txt
   ```

2. **确认配置文件**：
   - 检查 `config.yaml` 中的配置是否正确
   - 确认摄像头ID（0和1）是否正确
   - 确认ROI设置是否合理

3. **确认Pose文件夹**：
   - 检查 `Pose/` 文件夹下是否有 `poseA.png`, `poseB.png`, `poseC.png`

## 测试步骤

### 阶段1：基础功能测试（单摄像头窗口模式）

#### 测试1.1：单摄像头基础功能
```bash
# 启动单摄像头窗口模式
python run_with_rvm.py
```

**检查项**：
- [ ] 摄像头是否能正常打开并显示画面
- [ ] 是否能检测到人物（显示绿色背景，有人时显示抠像结果）
- [ ] 骨骼是否能正确绘制（蓝色默认，接近目标姿态时变暖色）
- [ ] 姿态比对评分是否显示（0-100分）
- [ ] 目标姿态预览图是否显示在右上角
- [ ] 按 ←/→ 或 A/D 键是否能切换目标姿态

**预期结果**：
- 画面流畅，没有明显卡顿
- 有人物时显示剪影风格（黑色人物+绿色背景）
- 骨骼颜色根据匹配度变化
- 评分实时更新

---

#### 测试1.2：抠像风格切换
编辑 `config.yaml`：
```yaml
matting:
  style: "original"  # 改为原图风格
```

重新运行：
```bash
python run_with_rvm.py
```

**检查项**：
- [ ] 人物是否显示为原图颜色（非黑色剪影）
- [ ] 背景是否为绿色

改回剪影风格：
```yaml
matting:
  style: "silhouette"  # 改回剪影风格
```

---

### 阶段2：双摄像头窗口模式测试

#### 测试2.1：双摄像头窗口模式
```bash
python run_dual_camera.py
```

**检查项**：
- [ ] 两个窗口是否同时打开（并排显示）
- [ ] 摄像头0和摄像头1是否都能正常显示
- [ ] 两个窗口是否都显示完整的抠像和骨骼
- [ ] 两个窗口的评分是否独立显示
- [ ] 在一个窗口按 ←/→ 时，两个窗口是否同步切换目标姿态
- [ ] 按ESC或Q键是否能正常退出

**预期结果**：
- 两个窗口并排显示
- 画面大小一致（只显示ROI区域，无黑边）
- 姿态切换同步

---

### 阶段3：系统托盘和后台服务测试

#### 测试3.1：系统托盘模式（默认后台服务）
```bash
python run_with_tray.py
```

**检查项**：
- [ ] 是否显示启动提示信息
- [ ] 系统托盘是否出现图标（任务栏右下角）
- [ ] 是否有Python窗口打开（应该没有，只有托盘）
- [ ] 查看控制台输出，是否看到：
  - `[INFO] 默认模式：后台服务（不显示窗口，推送Unity）`
  - `[INFO] 系统托盘已启动，程序在后台运行中...`
  - `[OK] 系统托盘图标已显示在任务栏`

**预期结果**：
- 只显示托盘图标，不显示窗口
- 程序在后台运行

---

#### 测试3.2：通过托盘打开调试窗口
右键点击系统托盘图标 → 选择 "启动后台服务（带调试窗口）"

**检查项**：
- [ ] 是否打开两个调试窗口
- [ ] 画面是否正常显示
- [ ] 控制台是否有错误信息

---

#### 测试3.3：后台服务模式（直接运行）
```bash
# 不显示窗口的后台模式
python run_backend_service.py

# 显示调试窗口的后台模式
python run_backend_service.py --show-window
```

**检查项**：
- [ ] 程序是否能正常启动
- [ ] 如果使用 `--show-window`，是否显示两个调试窗口
- [ ] 控制台输出是否简洁（没有大量DEBUG信息刷屏）
- [ ] 是否有ERROR或WARN信息（不应该有ERROR）

**预期结果**：
- 控制台输出简洁
- 只显示关键信息和错误/警告
- 没有每帧的详细DEBUG信息

---

### 阶段4：Unity通信测试（需要Unity配合）

#### 测试4.1：Python端启动后台服务
```bash
python run_backend_service.py
```

**检查项**：
- [ ] 控制台是否显示：
  - `初始化Unity通信...`
  - `[Unity通信] 已连接到Unity视频端口 127.0.0.1:8888` 或 `[WARN] 无法连接到Unity`
- [ ] 如果没有Unity运行，应该显示警告但程序继续运行

---

#### 测试4.2：Unity端连接测试
1. 在Unity中运行场景（包含 `PoseMatchReceiver` 组件）
2. 查看Unity Console

**检查项**：
- [ ] Unity Console是否显示 `[PoseMatchReceiver] 已连接到Python服务器`
- [ ] Unity是否接收到视频流数据
- [ ] Unity中的画面是否正常显示
- [ ] 评分是否实时更新

---

#### 测试4.3：Unity控制Pose切换
在Unity中点击按钮（下一个姿态/上一个姿态）

**检查项**：
- [ ] Python控制台是否显示：`[Unity通信] 收到pose切换命令`
- [ ] Python端的目标姿态是否切换
- [ ] Unity端显示的姿态名称是否更新

---

## 常见问题排查

### 问题1：摄像头无法打开
- 检查摄像头是否被其他程序占用
- 检查 `config.yaml` 中的 `device_id` 是否正确
- 尝试更换 `device_id`（0 或 1）

### 问题2：无法检测到人物
- 检查ROI设置是否合理（`config.yaml` 中的 `roi` 配置）
- 确认人物在ROI区域内
- 检查光照条件是否充足

### 问题3：Unity无法连接
- 确认Python服务已启动
- 检查端口8888和8889是否被占用
- 检查防火墙设置
- 确认Unity中的host和端口配置正确

### 问题4：控制台信息过多
- 确认 `VERBOSE_DEBUG = False`（已默认设置）
- 如果仍然有大量信息，检查是否有其他模块的debug输出

### 问题5：窗口立即关闭
- 检查窗口状态检查逻辑
- 尝试使用 `--show-window` 参数

---

## 测试检查清单

完成测试后，确认以下功能都正常：

### 核心功能
- [ ] 单摄像头模式正常工作
- [ ] 双摄像头模式正常工作
- [ ] 人物检测正常
- [ ] 姿态比对和评分正常
- [ ] 骨骼绘制正常（颜色随匹配度变化）
- [ ] 抠像功能正常（剪影/原图两种风格）
- [ ] 目标姿态切换正常

### 系统功能
- [ ] 系统托盘模式正常
- [ ] 后台服务模式正常
- [ ] 调试窗口可以正常打开/关闭
- [ ] 程序可以正常退出

### 通信功能（如果有Unity）
- [ ] Python能推送视频流到Unity
- [ ] Unity能接收并显示画面
- [ ] Unity能发送pose切换命令
- [ ] Python能接收并执行pose切换命令

### 用户体验
- [ ] 控制台输出简洁（没有大量debug信息）
- [ ] 关键错误信息清晰可见
- [ ] 没有明显的卡顿或崩溃

---

## 下一步

如果所有测试都通过：
1. ✅ 功能正常，可以投入使用
2. 如果Unity通信有问题，检查Unity端的脚本配置
3. 如果性能有问题，可以调整ROI或降低分辨率

如果测试发现问题：
1. 查看控制台的ERROR或WARN信息
2. 根据上面的"常见问题排查"进行诊断
3. 可以临时启用详细调试信息：修改 `src/human_matting.py` 中的 `VERBOSE_DEBUG = True`

