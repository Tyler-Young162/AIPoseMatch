# 使用指南

## 基本操作

### 启动程序

在项目根目录打开命令行，运行：

```bash
python src/main.py
```

或者如果您在src目录中：

```bash
python main.py
```

### 使用流程

1. **启动程序** - 摄像头会自动打开
2. **调整位置** - 站在摄像头前的ROI（有效区域）范围内
3. **观察结果** - 查看实时检测和抠像结果
4. **保存图像** - 按S键保存当前帧
5. **退出程序** - 按Q键退出

## 界面说明

### 四个显示面板

程序窗口分为2x2网格，显示四个面板：

#### 左上：Original（原始画面）
- 显示完整的摄像头画面
- 绿色矩形标记ROI有效区域
- 四角小圆点标记区域边界
- 左上角显示FPS和检测信息

#### 右上：ROI（有效区域）
- 显示裁剪后的ROI区域
- 这是实际进行检测的区域
- 如果没有人，显示空黑画面

#### 左下：Pose（骨骼检测）
- 显示ROI区域内的人物骨骼
- 绿色线条连接关键点
- 绿色圆点标记关节位置
- 只在检测到人物时显示

#### 右下：Matting（人体抠像）
- 显示抠像后的结果
- 人物保留原色
- 背景变黑或替换
- 当前使用简化算法，效果可能有限

### 状态信息

左上角显示的状态信息：

#### FPS（帧率）
- 实时帧率
- 目标：15-20 FPS
- 数值越高越流畅

#### Detections（检测数量）
- 当前ROI内检测到的人数
- 通常为0或1（MediaPipe主要支持单人）
- 多人时会显示具体数量

#### Score（评分）
显示最佳人物的综合评分：
- **C**: Completeness（完整性，0.0-1.0）
  - 可见关键点比例
  - 越高越完整
- **H**: Height（高度，0.0-1.0）
  - 相对高度（相比最高的人）
  - 越高的人得分越高
- **Ct**: Centeredness（居中度，0.0-1.0）
  - 距离ROI中心的远近
  - 越居中得分越高
- **总评分**: 加权组合分数

#### Keypoints（关键点数量）
- 可见关键点数量 / 总关键点数（33）
- 例如：28/33 表示33个关键点中看到28个

### 当前无人检测
- 显示红色警告："No person detected"
- 可能原因：
  - 不在ROI范围内
  - 光照不足
  - 检测置信度阈值过高

## 键盘控制

### Q 或 q
- **功能**: 退出程序
- **说明**: 安全退出，清理所有资源
- **响应**: 立即生效

### S 或 s
- **功能**: 保存当前帧
- **说明**: 保存完整显示面板（2x2组合图）
- **文件名**: output_frame_XXXXX.jpg
- **位置**: 项目根目录
- **响应**: 终端显示保存路径

### R 或 r
- **功能**: 切换ROI显示
- **说明**: 显示/隐藏ROI绿色标记矩形
- **响应**: 立即切换显示状态

## 配置调整

### ROI调整

编辑 `config.yaml` 中的 `roi` 部分：

```yaml
roi:
  x_min: 0.4  # 左侧边界（归一化，0.0到1.0）
  x_max: 0.6  # 右侧边界
  y_min: 0.0  # 上侧边界
  y_max: 0.8  # 下侧边界
```

**示例**：
- 默认：x=(0.4, 0.6), y=(0.0, 0.8) → 中央上半区域
- 全屏：x=(0.0, 1.0), y=(0.0, 1.0) → 整个画面
- 中央小区域：x=(0.45, 0.55), y=(0.2, 0.8) → 中央狭长条

### 人物选择权重

调整 `person_selection` 部分：

```yaml
person_selection:
  completeness_weight: 0.4  # 完整性权重（0.0-1.0）
  height_weight: 0.3        # 高度权重
  centeredness_weight: 0.3  # 居中度权重
  min_keypoints_visible: 8  # 最少可见关键点数
```

**示例**：
- 优先考虑完整性：0.6, 0.2, 0.2
- 优先考虑高度：0.2, 0.6, 0.2
- 优先考虑居中：0.2, 0.2, 0.6
- 注意：三个权重总和应该接近1.0

### 检测敏感度

调整 `pose` 部分：

```yaml
pose:
  min_detection_confidence: 0.5  # 检测置信度（0.0-1.0）
  min_tracking_confidence: 0.5   # 跟踪置信度
```

**说明**：
- 值越低越敏感（容易检测），但可能误检
- 值越高越严格（难检测），但更准确
- 建议范围：0.3-0.7

### 性能优化

调整 `matting` 部分：

```yaml
matting:
  downsample_ratio: 0.25  # 降采样比例（0.25-1.0）
  filter_incomplete: true # 是否过滤不完整人物
  min_person_height_ratio: 0.3 # 最小人物高度比例
```

**说明**：
- `downsample_ratio` 越小越快，但质量越低
- `filter_incomplete` 可减少误检
- `min_person_height_ratio` 过滤太远的人

## 技巧和建议

### 提高检测准确性

1. **光照条件**
   - 使用均匀的正面光照
   - 避免强逆光
   - 室内灯光效果更好

2. **站位**
   - 尽量站在ROI中心
   - 正面朝向摄像头
   - 保持完整身体可见
   - 距离适中（不要太远或太近）

3. **服装**
   - 避免与背景颜色相近
   - 穿着与肤色有明显区别的衣服
   - 避免过于宽松的服装遮挡

4. **背景**
   - 简单的背景效果更好
   - 避免复杂的图案和纹路
   - 减少背景中的其他人物

### 提高性能

1. **降低分辨率**
   ```yaml
   camera:
     resolution: [640, 480]  # 降低到640x480
   ```

2. **缩小ROI**
   ```yaml
   roi:
     x_min: 0.45
     x_max: 0.55
     y_min: 0.3
     y_max: 0.7
   ```

3. **降低处理质量**
   ```yaml
   matting:
     downsample_ratio: 0.5  # 增加降采样
   ```

4. **关闭不必要的显示**
   ```yaml
   display:
     show_skeleton: false   # 关闭骨骼显示
     show_matting: false    # 关闭抠像显示
   ```

## 故障排除

### 常见问题

#### 问题1：摄像头无法打开

**现象**: 终端显示 "Failed to initialize camera" 或黑屏

**解决方法**:
1. 检查 `device_id` 是否正确（尝试0, 1, 2...）
2. 确认摄像头未被其他程序占用
3. 重启程序

#### 问题2：检测不到人

**现象**: 显示 "No person detected"

**解决方法**:
1. 降低检测阈值：`min_detection_confidence: 0.3`
2. 调整光照条件
3. 确保在ROI范围内
4. 面向摄像头，完整身体可见

#### 问题3：帧率太低

**现象**: FPS显示小于10

**解决方法**:
1. 降低摄像头分辨率
2. 缩小ROI区域
3. 增加matting降采样
4. 检查CPU/GPU占用情况
5. 关闭其他程序

#### 问题4：选中了错误的人

**现象**: 背景人物被选中而非目标人物

**解决方法**:
1. 调整选择权重（增加高度或居中权重）
2. 缩小ROI排除背景人物
3. 降低 `min_person_height_ratio` 过滤太远的人
4. 确保目标人物最靠近摄像头

#### 问题5：抠像效果不好

**现象**: 边缘粗糙或有背景残留

**说明**: 当前使用简化的HSV颜色空间抠像，效果有限

**解决方法**:
1. 使用纯色背景（绿幕效果最好）
2. 增加光照均匀性
3. 调整服装颜色增加对比度
4. 考虑集成完整RVM模型

## 高级用法

### 命令行参数

```bash
# 指定配置文件
python src/main.py --config my_config.yaml

# 查看帮助
python src/main.py --help
```

### 批量测试

可以修改 `main.py` 添加：
- 自动保存间隔
- 性能统计输出
- 日志记录

### 自定义可视化

可以修改 `visualizer.py` 添加：
- 自定义颜色方案
- 不同的显示布局
- 额外的信息显示

## 输出文件

### 保存的图像

- **格式**: JPEG
- **名称**: output_frame_XXXXX.jpg
- **内容**: 完整2x2显示面板
- **位置**: 项目根目录

### 日志输出

当前在终端显示：
- 初始化信息
- FPS更新
- 错误消息

可以扩展添加日志文件输出。

## 下一步

完成基本使用后，可以：
1. 参考 `PROJECT_SUMMARY.md` 了解后续改进方向
2. 根据需求调整配置参数
3. 集成更多功能（如背景替换、动作识别）
4. 优化性能和提高准确性

祝使用愉快！

