# AI Pose Match - Unity通信完整测试指南

## ✅ 所有问题已修复

### 修复清单
1. ✅ 托盘虚拟环境问题
2. ✅ Unity连接方向错误
3. ✅ Unity端口冲突
4. ✅ 摄像头未初始化问题
5. ✅ 方法名错误（get_current_target_pose_name）
6. ✅ Unity主线程纹理更新问题
7. ✅ 双摄像头显示问题

## 🚀 完整测试流程

### 步骤1：启动Python后端

在PowerShell或CMD中运行：

```bash
cd C:\Users\yytsk\Documents\AIPoseMatch
.venv\Scripts\python.exe run_backend_service.py --show-window
```

**预期输出：**
```
[OK] 使用CUDA模式: NVIDIA GeForce RTX...
[INFO] Loading X target pose images...
[OK] Successfully loaded X target poses
[Unity通信] 视频流服务器已启动，等待Unity连接... 127.0.0.1:8888
[Unity通信] 视频流服务器已启动，等待Unity连接... 127.0.0.1:8889

后台服务开始运行...
按 ESC 或 Q 键退出（如果启用调试窗口）
```

**重要：等待Unity连接**

### 步骤2：启动Unity

1. 打开Unity Hub
2. 打开项目 `unity/AIPoseUnity`
3. 点击 **Play** 按钮

**Unity Console预期：**
```
[PoseMatchReceiver] 开始接收数据...
视频端口: 8888, 控制端口: 8889
[PoseMatchReceiver] 视频流：连接到Python 127.0.0.1:8888
[PoseMatchReceiver] 控制命令：将连接到Python 127.0.0.1:8889
[PoseMatchReceiver] 已连接到Python服务器 127.0.0.1:8888
```

**无报错！**

### 步骤3：验证功能

#### 3.1 Python调试窗口
- 两个OpenCV窗口显示实时画面
- 摄像头0和摄像头1都显示骨骼和匹配评分
- 评分实时更新

#### 3.2 Unity场景
- **camera0Material** 显示摄像头0画面（如果有配置）
- **camera1Material** 显示摄像头1画面（如果有配置）
- **score0Text** 显示摄像头0评分
- **score1Text** 显示摄像头1评分
- **poseNameText** 显示当前目标姿态名称

#### 3.3 测试控制按钮
1. 在Unity中点击"下一个姿态"按钮
2. Python Console应该显示：
   ```
   [Unity通信] 收到pose切换命令: {...}
   [INFO] Switched to pose: xxx
   ```
3. Unity显示的目标姿态名称更新

#### 3.4 键盘快捷键（Python调试窗口）
- 按 `Q` 或 `ESC` - 退出程序
- 按 `D` - 切换到下一个姿态
- 按 `A` - 切换到上一个姿态

## 🎯 成功标准

满足以下所有条件时，集成测试成功：
1. ✅ Python无错误启动
2. ✅ 两个摄像头初始化成功
3. ✅ Unity连接成功（无超时、无报错）
4. ✅ Python调试窗口显示两个画面
5. ✅ Unity场景显示两个画面（如果配置了Material）
6. ✅ 评分实时更新
7. ✅ 姿态名称显示
8. ✅ Unity按钮切换姿态
9. ✅ Python键盘快捷键工作
10. ✅ 无程序崩溃

## 📁 文件清单

### 核心文件
- `run_backend_service.py` - Python后端主程序
- `src/unity_communication.py` - Unity通信模块
- `src/pose_matcher.py` - 姿态比对模块
- `src/human_matting.py` - 抠像模块
- `unity/AIposeUnity/Assets/Scripts/PoseMatchReceiver.cs` - Unity接收脚本

### 修复文档
- `托盘问题修复说明.md` - 托盘环境问题
- `Unity连接修复说明.md` - 连接方向修复
- `Unity端口冲突修复.md` - 端口冲突修复
- `Unity线程修复说明.md` - 主线程问题修复
- `双摄像头修复说明.md` - 双摄像头显示修复

### 启动脚本
- `start_tray.ps1` - PowerShell托盘启动脚本
- `start_tray.bat` - CMD托盘启动脚本

## ⚠️ 重要提示

### 启动顺序
**必须按照以下顺序：**
1. **先**启动Python后端
2. **后**启动Unity（点击Play）

**原因：**
- Python作为服务器监听端口
- Unity作为客户端连接
- 如果先启动Unity，会找不到服务器

### 正确的测试命令
```bash
# Unity测试（推荐）
.venv\Scripts\python.exe run_backend_service.py --show-window

# 托盘模式（不用于Unity测试）
.venv\Scripts\python.exe run_with_tray.py

# 双摄像头本地模式（不用于Unity测试）
.venv\Scripts\python.exe run_dual_camera.py
```

### Unity场景配置
确保在Unity场景中配置了：
- ✅ `PoseMatchReceiver` 脚本已添加到GameObject
- ✅ `camera0Material` 已分配
- ✅ `camera1Material` 已分配
- ✅ `score0Text` 已分配
- ✅ `score1Text` 已分配
- ✅ `poseNameText` 已分配
- ✅ `nextPoseButton` 已分配
- ✅ `previousPoseButton` 已分配

## 🐛 故障排除

### Python无法启动
- 检查虚拟环境：`.venv\Scripts\python.exe --version`
- 检查依赖：`.venv\Scripts\pip list`
- 查看报错信息

### Unity连接失败
- 确认Python已先启动
- 检查端口8888是否被占用
- 确认网络设置（127.0.0.1）

### Unity有画面但没有纹理
- 检查 `camera0Material` 和 `camera1Material` 是否正确分配
- 确认Material使用了正确的Shader
- 查看Unity Console是否有错误

### 只显示一个摄像头
- ✅ 已修复！确认已应用最新版本

### 姿态切换不工作
- 检查按钮回调函数
- 查看Python Console是否收到命令
- 确认Pose文件夹中有多个姿态图片

## 📞 下一步

如果测试成功：
1. 录制演示视频
2. 记录性能数据
3. 优化延迟（如果需要）

如果有问题：
1. 截取错误日志
2. 检查配置文件
3. 查看详细文档

